name: PR Preview Cleanup
permissions:
  contents: read

on:
  pull_request:
    branches: [main]
    types: [closed]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  manual-tests-clean:
    runs-on: ubuntu-latest
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Remove Vercel alias
        run: |
          vercel alias rm pr-${{ github.event.pull_request.number }}.codjiflo.vza.net --yes --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} || echo "Alias not found"

      - name: Delete PR deployments
        run: |
          # List and delete deployments with this PR number in metadata
          deployments=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            "https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&teamId=${{ secrets.VERCEL_ORG_ID }}&meta-gitPrNumber=${{ github.event.pull_request.number }}" \
            | jq -r '.deployments[].uid // empty')
          for uid in $deployments; do
            echo "Deleting deployment $uid"
            curl -s -X DELETE -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v13/deployments/$uid?teamId=${{ secrets.VERCEL_ORG_ID }}" || echo "Failed to delete $uid"
          done
